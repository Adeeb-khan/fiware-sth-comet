#<a id="section0"></a> IoT-STH

* [Introduction] (#section1)
* [Dependencies](#section2)
* [Installation](#section3)
* [Inserting data (single events and aggregated data) into the database](#section4)
* [Querying data from the database](#section5)
* [Running the STH server](#section6)
* [Contact](#section7)

##<a id="section1"></a> Introduction
The STH component is a FIWARE component in charge of providing aggregated time series information about the evolution in
time of entity attribute values registered using the
<a href="http://catalogue.fiware.org/enablers/publishsubscribe-context-broker-orion-context-broker" target="_blank">Orion Context Broker</a>,
an implementation of the publish/subscribe context management system exposing NGSI9 and
<a href="http://technical.openmobilealliance.org/Technical/technical-information/release-program/current-releases/ngsi-v1-0">NGSI10</a> interfaces.

The aggregated time series information is stored in a MongoDB instance. This information can be generated by 2 main
means:

1. The STH component can directly subscribe to the Context Broker to receive notifications when the entity attribute
values change, calculating the aggregated time series information and storing it in the MongoDB instance.
This option is called the minimalist option.
2. A new sink can be enabled in the <a href="https://github.com/telefonicaid/fiware-cygnus" target="_blank">Cygnus</a>
component to calculate and to update the aggregated time series information
as the entity attribute values change over time. Using Cygnus adds a set of capabilities not available in the minimalist
option such as advanced filtering regarding the attributes to consider in the time series, advanced flow and congestion
management, amongst others. This option is provided as a
<a href="https://github.com/telefonicaid/fiware-cygnus/blob/master/flume/doc/devel/add_new_sink.md" target="_blank">Cygnus sink</a>
just like the <a href="https://github.com/telefonicaid/fiware-cygnus/tree/master/flume/src/main/java/es/tid/fiware/fiwareconnectors/cygnus/sinks" target="_blank">other data stores</a> already supported by Cygnus.
This option is the formal one.

Regarding the aggregated time series information provided by the STH component, there are 4 main concepts which are
important to know about:

* <b>Range</b>: The period of time about which the aggregated time series information is provided. Possible valid
ranges values are: year, month, day, hour, minute.
* <b>Resolution</b> or <b>aggregation period</b>: The time period by which the aggregated time series information is grouped.
Possible valid resolution values are: month, day, hour, minute and second. For the time being, we only consider the
following range-resolution pairs: year-month, month-day, day-hour, hour-minute and minute-second.
* <b>Origin</b>: For certain range-resolution pair, it is the origin of time for which the aggregated time series
information applies. For example, for a pair hour-minute, a valid origin value could be: ``2015-03-01T13:00:00.000Z```,
meaning the 13th hour of March, the 3rd, 2015. The origin is stored using UTC time to avoid locale issues.
* <b>Offset</b>: For certain range-resolution pair, it is the offset from the origin for which the aggregated time series
information applies. For example, for a pair hour-minute and an origin ```2015-03-01T13:00:00.000Z```, an offset of 10
refers to the 10th minute of the concrete hour pointed by the origin. In this example, there would be a maximum of 60
offsets from 0 to 59 corresponding to each one of the 60 minutes within the concrete hour.
* <b>Samples</b>: For a quadruple range-resolution-origin-offset, it is the number of samples, values, events or notifications available.

The STH component exposes an HTTP ReST API to let external clients query this aggregated time series information. A
typical URL querying for this information using a GET request is the following:

<pre>http://localhost:8666/STH/v1/contextEntities/type/&lt;quantity&gt;/id/&lt;entityId&gt;/attributes/&lt;attributeId&gt;?aggrMethod=sum&aggrPeriod=second&dateFrom=2015-02-22T00:00:00&dateTo=2015-02-22T23:00:00</pre>

The entries between "<" and ">" in the URL path depend on the concrete case (type of data, entity and attribute) being queried.

The requests can make use the following query parameters:

* <b>aggrMethod</b>: The aggregation method. The STH component supports the following aggregation methods: max (maximum
value), min (minimum value), sum (sum of all the samples) and sum2 (sum of the square value of all the samples). Combining
the information provided by these aggregated methods with the number of samples, it is possible to calculate probabilistic
values such as the average value, the variance as well as the standard deviation. It is a mandatory parameter.
* <b>aggrPeriod</b>: Aggregation period or resolution. For the time being, a fixed resolution determines the range as
well as the origin time format and the possible offsets. It is a mandatory parameter.
* <b>dateFrom</b>: The origin of time from which the aggregated time series information is desired. It is an optional parameter.
* <b>dateTo</b>: The end of time until which the aggregated time series information is desired. It is an optional parameter.

An example response provided by the STH component to a request such as the previous one could be the following:

<pre>
{
    "contextResponses": [
        {
            "contextElement": {
                "attributes": [
                    {
                        "name": "attributeId",
                        "values": [
                            {
                                "_id": {
                                    "origin": "2015-02-18T02:46:00.000Z",
                                    "range": "minute",
                                    "resolution": "second"
                                },
                                "points": [
                                    {
                                        "offset": 13,
                                        "samples": 1,
                                        "sum": 34.59
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "id": "entityId",
                "isPattern": false
            },
            "statusCode": {
                "code": "200",
                "reasonPhrase": "OK"
            }
        }
    ]
}
</pre>

In this example response, aggregated time series information for a range of minutes and a resolution of seconds is returned.
This information has as its origin the 46nd minute, of the 2nd hour of February, the 18th, 2015. And includes data for the
13th second, for which there is a sample and the sum (and value of that sample) is 34.59.

[Top](#section0)

##<a id="section2"></a> Dependencies
The STH component is a Node.js application which depends on certain Node.js modules as stated in the ```project.json``` file.

Apart from these Node.js modules, the STH component also needs a running MongoDB instance where the aggregated time series
information is stored for its proper functioning. Since the STH component uses MongoDB update operators (see
<a href="http://docs.mongodb.org/v2.6/reference/operator/update/" target="_blank">http://docs.mongodb.org/v2.6/reference/operator/update/</a>)
such as the ```$max``` and the ```$min``` update operators which were introduced in version 2.6, there is a dependency
of the STH component with this concrete version of the MongoDB instance where the aggregated data will be stored.
Consequently, a MongoDB instance version &gt;= 2.6 is needed to store the aggregated time series information.

[Top](#section0)

##<a id="section3"></a> Installation
1. Clone the repository:
<pre> git clone https://github.com/telefonicaid/IoT-STH.git </pre>
2. Get into the directory where the STH repository has been cloned:
<pre> cd IoT-STH/ </pre>
3. Install the Node.js modules and dependencies:
<pre> npm install </pre>
The STH component server is ready to be started.

[Top](#section0)

##<a id="section4"></a> Inserting data (single events and aggregated data) into the database
The STH component source code includes a set of tests to validate the correct functioning of the component. Amongst these
tests, there is a suite to validate the insertion of aggregated time series information into the MongoDB instance.

### Preconditions
A running instance of a MongoDB database.

### Running the tests
1. To run the tests, just execute:
<pre> make test-database </pre>

The script accepts the following parameters as environment variables:

- SAMPLES: The number of random events which will be generated and inserted into the database. Optional. Default value: "1".
- ENTITY_ID: The id of the entity for which the random event will be generated. Optional. Default value: "entityId".
- ATTRIBUTE_ID: The id of the attribute for which the random event will be generated. Optional. Default value: "attributeId"
- TYPE: The type of data of the value associated to generated random event. Optional. Default value: "quantity".
- START_DATE: The date from which the random events will be generated. Optional. Default value: "2015-01-01T00:00:00", UTC time.
- END_DATE: The date before which the random events will be generated. Optional. Default value: the current date and time.
- MIN_VALUE: The minimum value associated to the random events. Optional. Default value: "0".
- MAX_VALUE: The maximum value associated to the random events. Optional. Default value: "100".
- DB_USERNAME: The username to use for the database connection. Optional. Default value: "".
- DB_PASSWORD: The password to use for the database connection. Optional. Default value: "".
- DB_HOST: The host to use for the database connection. Optional. Default value: "localhost".
- DB_PORT: The port to use for the database connection. Optional. Default value: "27017".
- DB_NAME: The name of the database to use. Optional. Default value: "test".
- CLEAN: A flag indicating if the generated collections should be removed after the tests. Optional. Default value: "true".

For example, to insert 100 samples on a certain date without cleaning up the database after running the tests, use:
<pre>SAMPLES=100 START_DATE=2015-02-14T00:00:00 END_DATE=2015-02-14T23:59:59 CLEAN=false make test-database</pre>

In case of executing the tests with the CLEAN option set to false, the contents of the database can be inspected using the MongoDB
(```mongo```) shell.

[Top](#section0)

##<a id="section5"></a> Querying data from the database
The STH component source code includes a set of tests to validate the correct functioning of the component. Amongst these
tests, there is a suite to validate the query of the aggregated time series information into the MongoDB instance. Some
random aggregated time series data is previously inserted (using the previous test suite) to validate it querying.

### Preconditions
A running instance of a MongoDB database.

### Running the tests
1. To run the tests, just execute:
<pre> make test </pre>

The script accepts the following parameters as environment variables:

- SAMPLES: The number of random events which will be generated and inserted into the database. Optional. Default value: "1".
- ENTITY_ID: The id of the entity for which the random event will be generated. Optional. Default value: "entityId".
- ATTRIBUTE_ID: The id of the attribute for which the random event will be generated. Optional. Default value: "attributeId"
- TYPE: The type of data of the value associated to generated random event. Optional. Default value: "quantity".
- START_DATE: The date from which the random events will be generated. Optional. Default value: "2015-01-01T00:00:00", UTC time.
- END_DATE: The date before which the random events will be generated. Optional. Default value: the current date and time.
- MIN_VALUE: The minimum value associated to the random events. Optional. Default value: "0".
- MAX_VALUE: The maximum value associated to the random events. Optional. Default value: "100".
- DB_USERNAME: The username to use for the database connection. Optional. Default value: "".
- DB_PASSWORD: The password to use for the database connection. Optional. Default value: "".
- DB_HOST: The host to use for the database connection. Optional. Default value: "localhost".
- DB_PORT: The port to use for the database connection. Optional. Default value: "27017".
- DB_NAME: The name of the database to use. Optional. Default value: "test".
- CLEAN: A flag indicating if the generated collections should be removed after the tests. Optional. Default value: "true".
- FILTER_OUT_EMPTY: A flag indicating if the empty results should be removed from the response. Optional. Default value: "true".

For example, to insert 100 samples on a certain date without cleaning up the database after running the tests and query
each one of the possible combinations of aggregation method, aggregation period, range and resolution, use:
<pre>SAMPLES=100 START_DATE=2015-02-14T00:00:00 END_DATE=2015-02-14T23:59:59 CLEAN=false make test</pre>

In case of executing the tests with the CLEAN option set to false, the contents of the database can be inspected using the MongoDB
(```mongo```) shell.

[Top](#section0)

##<a id="section6"></a>Running the STH server
1. To run the STH server, just execute:
<pre> npm start </pre>

The script accepts the following parameters as environment variables:

- HOST: The host where the STH server will be started. Optional. Default value: "localhost".
- PORT: The port where the STH server will be listening. Optional. Default value: 8666.
- LOG_LEVEL: The logging level of the messages. Messages with a level equal or superior to this will be logged. Optional. Default value: "info".
- LOG_TO_CONSOLE: A flag indicating if the logs should be sent to the console. Optional. Default value: true.
- LOG_TO_FILE: A flag indicating if the logs should be sent to a file. Optional. Default value: true.
- LOG_DIR: The path to a directory where the log file will be searched for or created if it does not exist. Optional. Default value: "./log".
- LOG_FILE_NAME: The name of the file where the logs will be stored. Optional. Default value: "sth_app.log".
- DB_USERNAME: The username to use for the database connection. Optional. Default value: "".
- DB_PASSWORD: The password to use for the database connection. Optional. Default value: "".
- DB_HOST: The host to use for the database connection. Optional. Default value: "localhost".
- DB_PORT: The port to use for the database connection. Optional. Default value: "27017".
- DB_NAME: The name of the database to use. Optional. Default value: "test".
- FILTER_OUT_EMPTY: A flag indicating if the empty results should be removed from the response. Optional. Default value: "true".

For example, to start the STH server listening on port 7777, connecting to a MongoDB instance listening on mymongo.com:27777 and
without filtering out the empty results, use:

<pre> PORT=7777 DB_HOST=mymongo.com DB_PORT=27777 FILTER_OUT_EMPTY=false npm start</pre>

[Top](#section0)

##<a id="section6"></a>Contact
* Germán Toro del Valle (<a href="mailto:german.torodelvalle@telefonica.com">german.torodelvalle@telefonica.com</a>, <a href="http://www.twitter.com/gtorodelvalle" target="_blank">@gtorodelvalle</a>)
* Francisco Romero Bueno (<a href="mailto:francisco.romerobueno@telefonica.com">francisco.romerobueno@telefonica.com</a>)
* Iván Arias León (<a href="mailto:ivan.ariasleon@telefonica.com">ivan.ariasleon@telefonica.com</a>)

[Top](#section0)
